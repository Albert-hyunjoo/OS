# 데드락에 대해서

## 데드락의 정의
* 프로세스는 실행을 위해 *CPU, 메모리, 파일..* 등의 자원이 필요하다.
* 자원은 `요청`, `사용`, `반납` 순으로 진행이 된다.
* 자원의 분포, 할당, 대기 상태를 파악하기 위해 `자원 할당도`를 그리기도 한다.
* 한 프로세스가 어떤 자원을 점유하면서 다음 자원을 기다리는 경우 `교착 상태` 발생 가능성

### 교착 상태 (Deadlock) 필요 조건   
(*단, 4개 모두 충족됐다고 항상 Deadlock이 일어나는 건 아니다*)
* Mutual Exclusion (상호 배타)
* Hold and Wait (보유 및 대기)
* No Preemption (비선점)
* Circular Wait (환형 대기)    

## 데드락 처리 4가지 방법

### 교착상태 방지
* 앞서 본 **4가지 필요조건** 중 하나를 의도적으로 깨뜨린다.
* 단, `상호 배타`나 `비선점`은 대부분 상황에서 원천적으로 불가능
* `보유 및 대기`는 `All or Nothing` 방식으로 가지고 있는 상태에서 대기를 방지
* `환형 대기`의 경우에는 `자원에 번호를 부여`해서 `번호 오름차순`으로 요청

### 교착상태 회피
* CPU가 **안전하게** 자원을 할당하지 못하면 *파산 문제*등의 `교착 상태`가 발생

> |Process|Max Needs|Current Needs|        
> |---|---|---|    
> |P₀|10|5|    
> |P₁|4|2|    
> |P₂|9|2|
> **안전한 할당의 사례**    
> 1. 일단 P₀에 5개 분배 (12-5=7)
> 2. P₁에 2개 분배 (7-2=5)
> 3. P₂에 2개 분배 (5-2=3)
> 4. P₀에는 3개로 모자라므로 추가 분배 불가 (3개)
> 5. P₁에 2개 분배 (3-2=1)
> 6. P₁는 자원을 반환하므로 4개 반환 (1+4=5)
> 7. P₂에 분배하기는 모자란다 (5개)
> 8. P₀에 5개를 분배 (5-5=0)
> 9. P₀는 완료했으므로 10개를 반환 (0+10=10)
> 10. P₂에 나머지 7개 반환 (10-7=3) * 완료

> |Process|Max Needs|Current Needs|        
> |---|---|---|    
> |P₀|10|5|    
> |P₁|4|2|    
> |P₂|9|**3**|
> **불안전한 할당의 사례**
> 1. 일단 P₀에 5개 분배 (12-5=7)
> 2. P₁에 2개 분배 (7-2=5)
> 3. P₂에 3개 분배 (5-3=2)
> 4. P₀에는 2개로 모자라므로 추가 분배 불가 (2개)
> 5. P₁에 2개 분배 (2-2=0)
> 6. P₁는 자원을 반환하므로 4개 반환 (0+4=4)
> 7. P₀에도, P₂에도 남은 4개의 자원을 할당할 수 없음 (**데드락**)

### 교착상태 검출 및 복구
* 프로세스를 주기적으로 검사해서 `데드락` 발생 시 복구한다.
* 단, 검사와 복구를 위해 추가적인 `계산` 및 `메모리`가 요구된다.
* `복구`하는 두 가지 대표적 방법은 `프로세스 강제 종료` 및 `자원 선점 및 강제 할당`이 있다.

